<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>집계함수</title>
    <link rel="stylesheet" href="/src/css/study.css">

</head>
<body>
    <h1>집계함수</h1>

    <section>
        <h2>1. 집계 함수 (Aggregate Functions)</h2>
        <ul>
            <li>여러 행을 모아 하나의 결과로 집계할 때 사용한다</li>
            <li><code>GROUP BY</code>와 함께 활용되는 경우가 많다</li>
        </ul>
        <ul>
            <li><code>COUNT</code>: 행 개수 (전체, NULL 제외, DISTINCT 모두 가능)</li>
            <li><code>SUM</code>: 합계 (DISTINCT 가능)</li>
            <li><code>AVG</code>: 평균 (DISTINCT 가능)</li>
            <li><code>MAX</code>: 최댓값</li>
            <li><code>MIN</code>: 최솟값</li>
            <li><code>STDDEV</code>: 표준편차</li>
            <li><code>VARIANCE</code>: 분산</li>
            <li><code>MEDIAN</code>: 중앙값</li>
        </ul>
        <pre><code>SELECT deptno,
       COUNT(*) AS 인원수,
       COUNT(DISTINCT job) AS 직무개수,
       SUM(sal) AS 총급여,
       AVG(sal) AS 평균급여,
       MAX(sal) AS 최고급여,
       MIN(sal) AS 최저급여
FROM emp;
</code></pre>
    </section>
    <section>
        <h2>2. DISTINCT</h2>
        <ul>
            <li><code>DISTINCT</code>는 함수(Function)가 아니라 <strong>SQL 키워드</strong>이다</li>
            <li>SELECT 결과 집합에서 <strong>중복된 행을 제거</strong>하는 역할을 한다</li>
            <li>집계 함수 안에서는 <strong>옵션</strong>처럼 사용되어 중복을 제외한 값을 대상으로 연산한다</li>
        </ul>

        <h3>(1) SELECT 절에서 사용</h3>
        <pre><code>-- 직무(JOB) 중복 제거
    SELECT DISTINCT job
    FROM emp;

    -- 부서와 직무 조합 중복 제거
    SELECT DISTINCT deptno, job
    FROM emp;
    </code></pre>

        <h3>(2) 집계 함수 안에서 사용</h3>
        <pre><code>-- 중복을 제거한 직무 개수
    SELECT COUNT(DISTINCT job)
    FROM emp;

    -- 중복을 제거한 급여 평균
    SELECT AVG(DISTINCT sal)
    FROM emp;
    </code></pre>
    </section>

    <section>
        <h2>3. GROUP BY 절</h2>
        <ul>
            <li><code>GROUP BY</code>는 특정 컬럼의 값을 기준으로 행들을 묶어 집계 연산을 수행할 때 사용한다</li>
            <li>집계 함수(<code>SUM</code>, <code>AVG</code>, <code>COUNT</code>, <code>MAX</code>, <code>MIN</code> 등)와 함께 자주 사용된다</li>
            <li>SELECT 절에는 <code>GROUP BY</code>에 명시된 컬럼과 집계 함수만 올 수 있다</li>
        </ul>
        <pre><code>-- 부서별 급여 합계
SELECT deptno, SUM(sal) AS 총급여
FROM emp
GROUP BY deptno;

-- 부서별 직무별 인원 수
SELECT deptno, job, COUNT(*) AS 인원수
FROM emp
GROUP BY deptno, job;
</code></pre>
    </section>
    <section>
        <h2>4. HAVING 절</h2>
        <ul>
            <li><code>HAVING</code>은 그룹화된 결과에 조건을 주는 절이다</li>
            <li><code>WHERE</code>는 그룹화 이전의 행에 조건을 주고, <code>HAVING</code>은 그룹화 이후의 집계 결과에 조건을 준다</li>
            <li>집계 함수 조건은 반드시 <code>HAVING</code> 절에서 사용해야 한다</li>
        </ul>
        <pre><code>-- 부서별 평균 급여
-- 단, 평균 급여가 2000 이상인 부서만 출력
SELECT deptno, AVG(sal) AS 평균급여
FROM emp
GROUP BY deptno
HAVING AVG(sal) &gt;= 2000;

-- 직무별 인원 수
-- 단, 인원이 5명 이상인 직무만 출력
SELECT job, COUNT(*) AS 인원수
FROM emp
GROUP BY job
HAVING COUNT(*) &gt;= 5;
</code></pre>
    </section>
    <section>
        <h2>집계 함수 연습 문제 (GROUP BY / HAVING 포함)</h2>
        <ol>
            <li>부서(deptno)별 인원수를 구하라. 컬럼명은 인원수로 표시하라.</li>
            <li>부서(deptno)별 급여(sal) 합계를 구하고 합계가 큰 순으로 정렬하라. 컬럼명은 총급여로 하라.</li>
            <li>직무(job)별 평균 급여를 소수점 둘째 자리까지 반올림하여 구하라. 컬럼명은 평균급여로 하라.</li>
            <li>부서(deptno)별 최댓값/최솟값 급여를 함께 구하라. 컬럼명은 각각 최고급여, 최저급여로 하라.</li>
            <li>부서(deptno)와 직무(job)별 인원수를 구하라. 인원수가 3명 이상인 그룹만 출력하라.</li>
            <li>부서(deptno)별로 중복을 제거한 직무(job) 개수를 구하라. 컬럼명은 직무개수로 하라.</li>
            <li>보너스(comm)가 NULL이 아닌 사원만 대상으로, 직무(job)별 평균 보너스를 구하라.</li>
            <li>부서(deptno)별 급여 합계가 10000 이상인 부서만 출력하라. 합계 컬럼명은 총급여로 하라.</li>
            <li>입사일(hiredate)을 월 단위(YYYY-MM)로 묶어 월별 입사 인원수를 구하고 최신 월이 먼저 오도록 정렬하라.</li>
            <li>직무(job)별로 급여 평균이 2500 이상인 그룹만 출력하고, 평균은 소수점 한 자리까지 표시하라.</li>
            <li>부서(deptno)별로 급여가 3000 이상인 사원 수와 3000 미만인 사원 수를 각각 구해 한 행에 보여라.</li>
            <li>부서(deptno)별로 사원들의 고유 급여(sal, 중복 제거)의 평균을 구하라. 컬럼명은 고유평균급여로 하라.</li>
            <li>직무(job)별로 급여의 표준편차와 분산을 구하라. 컬럼명은 각각 표준편차, 분산으로 하라.</li>
            <li>부서(deptno)별로 사원 수가 가장 많은 직무(job)만 출력하라. 동률이면 모두 출력하라.</li>
            <li>직무(job)별로 보너스(comm)를 받는 사원 비율(보너스 있는 인원 / 전체 인원 × 100)을 소수점 둘째 자리까지 구하라.</li>
            <li>부서(deptno)별 급여 중앙값을 구하라. 컬럼명은 중앙값으로 하라.</li>
            <li>부서(deptno)별, 직무(job)별로 급여 합계를 구하고, 부서 내에서 합계가 큰 순으로 정렬하라.</li>
            <li>부서(deptno)별 급여 합계와 평균을 구하되, 부서 번호가 10 또는 20인 경우만 출력하라.</li>
            <li>전체 사원을 하나의 그룹으로 보고, 전체 인원수, 서로 다른 직무 수, 급여 평균을 한 행에 출력하라.</li>
            <li>부서(deptno)별로 급여 평균이 각 부서의 최대 급여의 60% 이상인 부서만 출력하라.</li>
        </ol>
    </section>
    <section>
        <h2>집계 함수 정답 (GROUP BY / HAVING 포함)</h2>
        <ol>
            <li>
      <pre><code>SELECT deptno, COUNT(*) AS 인원수
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, SUM(sal) AS 총급여
FROM emp
GROUP BY deptno
ORDER BY SUM(sal) DESC;</code></pre>
            </li>

            <li>
      <pre><code>SELECT job, ROUND(AVG(sal), 2) AS 평균급여
FROM emp
GROUP BY job;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno,
       MAX(sal) AS 최고급여,
       MIN(sal) AS 최저급여
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, job, COUNT(*) AS 인원수
FROM emp
GROUP BY deptno, job
HAVING COUNT(*) &gt;= 3;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, COUNT(DISTINCT job) AS 직무개수
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT job, AVG(comm) AS 평균보너스
FROM emp
WHERE comm IS NOT NULL
GROUP BY job;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, SUM(sal) AS 총급여
FROM emp
GROUP BY deptno
HAVING SUM(sal) &gt;= 10000;</code></pre>
            </li>

            <li>
      <pre><code>SELECT TO_CHAR(hiredate, 'YYYY-MM') AS 입사월,
       COUNT(*) AS 인원수
FROM emp
GROUP BY TO_CHAR(hiredate, 'YYYY-MM')
ORDER BY 입사월 DESC;</code></pre>
            </li>

            <li>
      <pre><code>SELECT job, ROUND(AVG(sal), 1) AS 평균급여
FROM emp
GROUP BY job
HAVING AVG(sal) &gt;= 2500;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno,
       SUM(CASE WHEN sal &gt;= 3000 THEN 1 ELSE 0 END) AS "3000이상",
       SUM(CASE WHEN sal &lt; 3000 THEN 1 ELSE 0 END)  AS "3000미만"
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, AVG(DISTINCT sal) AS 고유평균급여
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT job,
       STDDEV(sal)   AS 표준편차,
       VARIANCE(sal) AS 분산
FROM emp
GROUP BY job;</code></pre>
            </li>

            <li>
      <pre><code>WITH cnt AS (
  SELECT deptno, job, COUNT(*) AS cnt
  FROM emp
  GROUP BY deptno, job
),
rk AS (
  SELECT deptno, job, cnt,
         DENSE_RANK() OVER (PARTITION BY deptno ORDER BY cnt DESC) AS rk
  FROM cnt
)
SELECT deptno, job, cnt
FROM rk
WHERE rk = 1
ORDER BY deptno, job;</code></pre>
            </li>

            <li>
      <pre><code>SELECT job,
       ROUND(AVG(CASE WHEN comm IS NOT NULL THEN 1 ELSE 0 END) * 100, 2) AS 보너스비율
FROM emp
GROUP BY job;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, MEDIAN(sal) AS 중앙값
FROM emp
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno, job, SUM(sal) AS 합계
FROM emp
GROUP BY deptno, job
ORDER BY deptno, SUM(sal) DESC;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno,
       SUM(sal) AS 총급여,
       AVG(sal) AS 평균급여
FROM emp
WHERE deptno IN (10, 20)
GROUP BY deptno;</code></pre>
            </li>

            <li>
      <pre><code>SELECT COUNT(*) AS 전체인원,
       COUNT(DISTINCT job) AS 직무수,
       AVG(sal) AS 급여평균
FROM emp;</code></pre>
            </li>

            <li>
      <pre><code>SELECT deptno,
       AVG(sal) AS 평균급여,
       MAX(sal) AS 최고급여
FROM emp
GROUP BY deptno
HAVING AVG(sal) &gt;= 0.6 * MAX(sal);</code></pre>
            </li>
        </ol>
    </section>
</body>
</html>